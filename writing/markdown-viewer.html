<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Loading - Minseok (Denis) Kim</title>
    <link rel="stylesheet" href="../styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- MathJax for LaTeX rendering -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                ignoreHtmlClass: ".*|",
                processHtmlClass: "arithmatex"
            }
        };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Marked for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Prism for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <div class="site-branding">
                <h1 class="site-title">Minseok (Denis) Kim</h1>
            </div>
            <nav class="main-nav">
                <a href="../#main" class="nav-link">Main</a>
                <a href="../papers/" class="nav-link">Papers</a>
                <a href="../code/" class="nav-link">Code</a>
                <a href="../writing/" class="nav-link">Writing</a>
                <div class="theme-toggle" onclick="toggleTheme()">
                    <div class="theme-icon"></div>
                </div>
            </nav>
        </div>
    </header>

    <main class="content">
        <article class="post-content">
            <div class="container">
                <header class="post-header" id="post-header">
                    <!-- Header content will be populated by JS -->
                </header>

                <div class="post-body" id="post-content">
                    <!-- Markdown content will be rendered here -->
                    <p>Loading...</p>
                </div>

                <footer class="post-footer">
                    <a href="../" class="back-link">← Back to Writing</a>
                </footer>
            </div>
        </article>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="mailto:for8821@g.skku.edu">Email</a>
                    <a href="https://scholar.google.com/citations?user=81uf6x0AAAAJ&hl=en">Scholar</a>
                    <a href="https://github.com/DenisKimskku">GitHub</a>
                </div>
                <p class="footer-text">© 2025 Minseok (Denis) Kim. Building safe AI for everyone.</p>
            </div>
        </div>
    </footer>

    <script src="../script.js"></script>
    <script>
        // Configure marked options for LaTeX compatibility
        marked.setOptions({
            highlight: function(code, lang) {
                if (Prism.languages[lang]) {
                    return Prism.highlight(code, Prism.languages[lang], lang);
                } else {
                    return code;
                }
            },
            langPrefix: 'language-',
            pedantic: false,
            gfm: true,
            breaks: false,
            sanitize: false,
            smartypants: false,
            xhtml: false
        });

        // Function to parse frontmatter
        function parseFrontmatter(content) {
            const frontmatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/;
            const match = content.match(frontmatterRegex);
            
            if (match) {
                const frontmatter = {};
                const frontmatterText = match[1];
                const bodyContent = match[2];
                
                // Parse YAML-like frontmatter
                frontmatterText.split('\n').forEach(line => {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex > 0) {
                        const key = line.substring(0, colonIndex).trim();
                        const value = line.substring(colonIndex + 1).trim().replace(/^["']|["']$/g, '');
                        frontmatter[key] = value;
                    }
                });
                
                return { frontmatter, content: bodyContent };
            }
            
            return { frontmatter: {}, content };
        }

        // Function to load and render markdown
        async function loadMarkdown() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const markdownPath = urlParams.get('md') || urlParams.get('file');
                
                if (!markdownPath) {
                    throw new Error('No markdown file specified. Use ?md=path/to/file.md');
                }

                const response = await fetch(markdownPath);
                if (!response.ok) {
                    throw new Error(`Failed to load ${markdownPath}: ${response.statusText}`);
                }

                const rawContent = await response.text();
                const { frontmatter, content } = parseFrontmatter(rawContent);

                // Update page title
                const title = frontmatter.title || 'Article';
                document.getElementById('page-title').textContent = `${title} - Minseok (Denis) Kim`;

                // Create header content
                const headerHtml = `
                    <div class="post-meta">
                        <span class="post-date">${frontmatter.date || ''}</span>
                        <span class="post-type">${frontmatter.type || 'Article'}</span>
                    </div>
                    <h1>${title}</h1>
                    ${frontmatter.description ? `<p class="post-description">${frontmatter.description}</p>` : ''}
                `;
                document.getElementById('post-header').innerHTML = headerHtml;

                // Pre-process content for better LaTeX handling
                let processedContent = content;
                
                // Protect LaTeX expressions from markdown processing by temporarily encoding them
                const latexExpressions = [];
                let index = 0;
                
                // Handle display math $$...$$
                processedContent = processedContent.replace(/\$\$([^$]+?)\$\$/g, (match, expr) => {
                    const placeholder = `LATEX_DISPLAY_${index++}`;
                    latexExpressions[placeholder] = `$$${expr}$$`;
                    return placeholder;
                });
                
                // Handle inline math $...$
                processedContent = processedContent.replace(/\$([^$\n]+?)\$/g, (match, expr) => {
                    const placeholder = `LATEX_INLINE_${index++}`;
                    latexExpressions[placeholder] = `$${expr}$`;
                    return placeholder;
                });
                
                // Render markdown content
                let htmlContent = marked.parse(processedContent);
                
                // Restore LaTeX expressions
                for (const [placeholder, latexExpr] of Object.entries(latexExpressions)) {
                    htmlContent = htmlContent.replace(new RegExp(placeholder, 'g'), latexExpr);
                }
                
                // Fix relative figure paths - assume figures are in figures/article-name/
                const articleName = markdownPath.replace('.md', '').split('/').pop();
                const figuresPath = `figures/${articleName}/`;
                
                // Replace relative image paths with correct figure paths
                htmlContent = htmlContent.replace(
                    /<img([^>]*?)src="([^"]*?\.(?:png|jpg|jpeg|gif|svg))"([^>]*?)>/gi,
                    (match, prefix, src, suffix) => {
                        // If src doesn't start with http/https and doesn't start with figures/
                        if (!src.startsWith('http') && !src.startsWith('figures/')) {
                            return `<img${prefix}src="${figuresPath}${src}"${suffix}>`;
                        }
                        return match;
                    }
                );
                
                document.getElementById('post-content').innerHTML = htmlContent;

                // Re-run MathJax on the new content
                if (window.MathJax) {
                    MathJax.typesetPromise([document.getElementById('post-content')]).catch((err) => {
                        console.log('MathJax error: ' + err.message);
                    });
                }

            } catch (error) {
                console.error('Error loading markdown:', error);
                document.getElementById('post-content').innerHTML = `
                    <div class="error">
                        <h2>Error Loading Content</h2>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Load markdown when page loads
        document.addEventListener('DOMContentLoaded', loadMarkdown);
    </script>
</body>
</html>