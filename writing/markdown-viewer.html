<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Loading - Minseok (Denis) Kim</title>
    <link rel="stylesheet" href="../styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Enhanced Typography and Readability */
        .post-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .post-body {
            line-height: 1.8;
            font-size: 1.1rem;
            color: var(--text-color);
        }

        .post-body h1, .post-body h2, .post-body h3, .post-body h4 {
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
            line-height: 1.3;
        }

        .post-body h1 {
            font-size: 2.2rem;
            margin-top: 3rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        .post-body h2 {
            font-size: 1.8rem;
            margin-top: 2.5rem;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid var(--border-color);
        }

        .post-body h3 {
            font-size: 1.4rem;
            color: var(--accent-color);
        }

        .post-body h4 {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .post-body p {
            margin-bottom: 1.5rem;
            text-align: justify;
        }

        .post-body ul, .post-body ol {
            margin-bottom: 1.5rem;
            padding-left: 2rem;
        }

        .post-body li {
            margin-bottom: 0.5rem;
            line-height: 1.7;
        }

        .post-body strong {
            font-weight: 600;
            color: var(--accent-color);
        }

        .post-body em {
            font-style: italic;
            color: var(--secondary-text-color);
        }

        .post-body code {
            font-family: 'Monaco', 'Courier New', monospace;
            background-color: var(--card-bg-color);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9em;
            border: 1px solid var(--border-color);
        }

        .post-body pre {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            overflow-x: auto;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .post-body pre code {
            background: none;
            padding: 0;
            border: none;
            font-size: 0.95rem;
        }

        .post-body blockquote {
            border-left: 4px solid var(--accent-color);
            padding-left: 1.5rem;
            margin: 1.5rem 0;
            color: var(--secondary-text-color);
            font-style: italic;
            background-color: var(--card-bg-color);
            padding: 1rem 1.5rem;
            border-radius: 4px;
        }

        .post-body img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 2rem auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .post-body a {
            color: var(--accent-color);
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s ease;
        }

        .post-body a:hover {
            border-bottom-color: var(--accent-color);
        }

        .post-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .post-body th {
            background-color: var(--accent-color);
            color: white;
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
        }

        .post-body td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .post-body tr:hover {
            background-color: var(--card-bg-color);
        }

        /* LaTeX Math Styling */
        .post-body .katex-display {
            margin: 2rem 0;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 1rem;
            background-color: var(--card-bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .post-body .katex {
            font-size: 1.1em;
        }

        /* Post Header Styling */
        .post-header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
        }

        .post-meta {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--secondary-text-color);
        }

        .post-date, .post-type {
            padding: 0.25rem 0.75rem;
            background: var(--card-bg-color);
            border-radius: 15px;
        }

        .post-header h1 {
            font-size: 2.5rem;
            margin: 1rem 0;
            line-height: 1.2;
        }

        .post-description {
            font-size: 1.2rem;
            color: var(--secondary-text-color);
            line-height: 1.6;
            max-width: 700px;
            margin: 1rem auto 0;
        }

        .post-footer {
            margin-top: 4rem;
            padding-top: 2rem;
            border-top: 2px solid var(--border-color);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 500;
            transition: transform 0.2s ease;
        }

        .back-link:hover {
            transform: translateX(-5px);
        }

        /* Loading State */
        .post-body p:first-child {
            color: var(--secondary-text-color);
            font-style: italic;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .post-body {
                font-size: 1rem;
            }

            .post-body h1 {
                font-size: 1.8rem;
            }

            .post-body h2 {
                font-size: 1.5rem;
            }

            .post-body h3 {
                font-size: 1.2rem;
            }

            .post-header h1 {
                font-size: 2rem;
            }

            .post-description {
                font-size: 1rem;
            }

            .post-body table {
                font-size: 0.9rem;
            }
        }

        /* Dark Mode Enhancements */
        [data-theme="dark"] .post-body img {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .post-body pre {
            background-color: #1e1e1e;
        }

        [data-theme="dark"] .post-body .katex-display {
            background-color: #1e1e1e;
        }
    </style>
    
    <!-- MathJax for LaTeX rendering -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                packages: {'[+]': ['noerrors']}
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'annotation', 'annotation-xml']
            },
            loader: {load: ['[tex]/noerrors']},
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    console.log('MathJax is ready');
                    // Trigger a custom event when MathJax is fully ready
                    window.dispatchEvent(new Event('mathjax-ready'));
                }
            }
        };
        
        // Global flag to track MathJax readiness
        window.mathJaxReady = false;
        window.addEventListener('mathjax-ready', () => {
            window.mathJaxReady = true;
        });
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Marked for markdown parsing - disable Cloudflare Rocket Loader -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"
            data-cfasync="false"
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- DOMPurify for XSS protection -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"
            data-cfasync="false"
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Alternative: KaTeX for faster LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer data-cfasync="false" src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer data-cfasync="false" src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Prism for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet"
          crossorigin="anonymous" referrerpolicy="no-referrer">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet"
          crossorigin="anonymous" referrerpolicy="no-referrer">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"
            data-cfasync="false"
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"
            data-cfasync="false"
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <div class="site-branding">
                <h1 class="site-title">Minseok (Denis) Kim</h1>
            </div>
            <nav class="main-nav">
                <a href="../#main" class="nav-link">Main</a>
                <a href="../papers/" class="nav-link">Papers</a>
                <a href="../code/" class="nav-link">Code</a>
                <a href="../writing/" class="nav-link">Writing</a>
                <div class="theme-toggle" onclick="toggleTheme()">
                    <div class="theme-icon"></div>
                </div>
            </nav>
        </div>
    </header>

    <main class="content">
        <article class="post-content">
            <div class="container">
                <header class="post-header" id="post-header">
                    <!-- Header content will be populated by JS -->
                </header>

                <div class="post-body" id="post-content">
                    <!-- Markdown content will be rendered here -->
                    <p>Loading...</p>
                </div>

                <footer class="post-footer">
                    <a href="../" class="back-link">← Back to Writing</a>
                </footer>
            </div>
        </article>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="mailto:for8821@g.skku.edu">Email</a>
                    <a href="https://scholar.google.com/citations?user=81uf6x0AAAAJ&hl=en">Scholar</a>
                    <a href="https://github.com/DenisKimskku">GitHub</a>
                </div>
                <p class="footer-text">© 2025 Minseok (Denis) Kim. Building safe AI for everyone.</p>
            </div>
        </div>
    </footer>

    <script src="../script.js"></script>
    <script data-cfasync="false">
        // Wait for all libraries to load before initializing
        function initializeMarkdownViewer() {
            // Check if all required libraries are loaded
            if (typeof marked === 'undefined' || typeof DOMPurify === 'undefined') {
                console.log('Libraries not ready, retrying...');
                setTimeout(initializeMarkdownViewer, 100);
                return;
            }

            // Configure marked options for LaTeX compatibility
            marked.setOptions({
            highlight: function(code, lang) {
                if (Prism.languages[lang]) {
                    return Prism.highlight(code, Prism.languages[lang], lang);
                } else {
                    return code;
                }
            },
            langPrefix: 'language-',
            pedantic: false,
            gfm: true,
            breaks: false,
            sanitize: false,
            smartypants: false,
            xhtml: false
        });

        // Custom extensions for marked to preserve LaTeX
        marked.use({
            extensions: [{
                name: 'latex-inline',
                level: 'inline',
                start(src) { return src.indexOf('$'); },
                tokenizer(src, tokens) {
                    const match = src.match(/^\$([^$\n]+?)\$/);
                    if (match) {
                        return {
                            type: 'latex-inline',
                            raw: match[0],
                            text: match[1].trim()
                        };
                    }
                },
                renderer(token) {
                    return `$${token.text}$`;
                }
            }, {
                name: 'latex-display',
                level: 'block',
                start(src) { return src.indexOf('$$'); },
                tokenizer(src, tokens) {
                    const match = src.match(/^\$\$([^$]+?)\$\$/);
                    if (match) {
                        return {
                            type: 'latex-display',
                            raw: match[0],
                            text: match[1].trim()
                        };
                    }
                },
                renderer(token) {
                    return `$$${token.text}$$`;
                }
            }]
        });
        }

        // Function to parse frontmatter
        function parseFrontmatter(content) {
            const frontmatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/;
            const match = content.match(frontmatterRegex);
            
            if (match) {
                const frontmatter = {};
                const frontmatterText = match[1];
                const bodyContent = match[2];
                
                // Parse YAML-like frontmatter
                frontmatterText.split('\n').forEach(line => {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex > 0) {
                        const key = line.substring(0, colonIndex).trim();
                        const value = line.substring(colonIndex + 1).trim().replace(/^["']|["']$/g, '');
                        frontmatter[key] = value;
                    }
                });
                
                return { frontmatter, content: bodyContent };
            }
            
            return { frontmatter: {}, content };
        }

        // Function to render LaTeX with multiple fallbacks
        function renderMathJax() {
            console.log('🔢 Attempting to render LaTeX...');
            
            const contentElement = document.getElementById('post-content');
            
            // Method 1: Try KaTeX first (faster)
            const tryKaTeX = () => {
                if (window.renderMathInElement && window.katex) {
                    console.log('📐 Using KaTeX for LaTeX rendering...');
                    try {
                        renderMathInElement(contentElement, {
                            delimiters: [
                                {left: '$$', right: '$$', display: true},
                                {left: '$', right: '$', display: false},
                                {left: '\\[', right: '\\]', display: true},
                                {left: '\\(', right: '\\)', display: false}
                            ],
                            throwOnError: false,
                            errorColor: '#cc0000',
                            strict: false
                        });
                        console.log('✅ KaTeX rendering complete');
                        return true;
                    } catch (err) {
                        console.warn('⚠️ KaTeX error, trying MathJax:', err);
                        return false;
                    }
                }
                return false;
            };
            
            // Method 2: Fallback to MathJax
            const tryMathJax = () => {
                if (window.MathJax && MathJax.typesetPromise) {
                    console.log('🧮 Using MathJax for LaTeX rendering...');
                    MathJax.typesetPromise([contentElement])
                        .then(() => {
                            console.log('✅ MathJax rendering complete');
                        })
                        .catch((err) => {
                            console.error('❌ MathJax error:', err);
                        });
                    return true;
                }
                return false;
            };
            
            // Try KaTeX first, then MathJax
            const renderLaTeX = () => {
                if (!tryKaTeX()) {
                    if (!tryMathJax()) {
                        console.log('⏳ LaTeX libraries not ready, retrying...');
                        setTimeout(renderLaTeX, 100);
                    }
                }
            };
            
            // Start rendering
            setTimeout(renderLaTeX, 100);
        }

        // Utility function to safely escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Function to load and render markdown
        async function loadMarkdown() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const markdownPath = urlParams.get('md') || urlParams.get('file');

                if (!markdownPath) {
                    throw new Error('No markdown file specified. Use ?md=path/to/file.md');
                }

                const response = await fetch(markdownPath);
                if (!response.ok) {
                    throw new Error(`Failed to load ${markdownPath}: ${response.statusText}`);
                }

                const rawContent = await response.text();
                const { frontmatter, content } = parseFrontmatter(rawContent);

                // Update page title safely
                const title = frontmatter.title || 'Article';
                document.getElementById('page-title').textContent = `${title} - Minseok (Denis) Kim`;

                // Create header content safely using DOM manipulation
                const postHeader = document.getElementById('post-header');
                postHeader.innerHTML = ''; // Clear existing content

                const postMeta = document.createElement('div');
                postMeta.className = 'post-meta';

                const postDate = document.createElement('span');
                postDate.className = 'post-date';
                postDate.textContent = frontmatter.date || '';
                postMeta.appendChild(postDate);

                const postType = document.createElement('span');
                postType.className = 'post-type';
                postType.textContent = frontmatter.type || 'Article';
                postMeta.appendChild(postType);

                const h1 = document.createElement('h1');
                h1.textContent = title;

                postHeader.appendChild(postMeta);
                postHeader.appendChild(h1);

                if (frontmatter.description) {
                    const description = document.createElement('p');
                    description.className = 'post-description';
                    description.textContent = frontmatter.description;
                    postHeader.appendChild(description);
                }

                // Remove the first H1 from content if it matches the title (to avoid duplicate)
                let contentToRender = content;
                const firstH1Match = content.match(/^#\s+(.+)$/m);
                if (firstH1Match && firstH1Match[1].trim() === title.trim()) {
                    contentToRender = content.replace(/^#\s+.+$/m, '').trim();
                }

                // Render markdown with sanitization
                let htmlContent = marked.parse(contentToRender);

                // Fix relative figure paths - assume figures are in figures/article-name/
                const articleName = markdownPath.replace('.md', '').split('/').pop();
                const figuresPath = `figures/${articleName}/`;

                // Replace relative image paths with correct figure paths
                htmlContent = htmlContent.replace(
                    /<img([^>]*?)src="([^"]*?\.(?:png|jpg|jpeg|gif|svg))"([^>]*?)>/gi,
                    (match, prefix, src, suffix) => {
                        // If src doesn't start with http/https and doesn't start with figures/
                        if (!src.startsWith('http') && !src.startsWith('figures/')) {
                            return `<img${prefix}src="${figuresPath}${src}"${suffix}>`;
                        }
                        return match;
                    }
                );

                // Sanitize HTML with DOMPurify before inserting
                const contentElement = document.getElementById('post-content');

                // Wait for DOMPurify to load if not available yet
                const sanitizeAndRender = () => {
                    if (window.DOMPurify) {
                        // Allow MathJax delimiters and common markdown elements
                        const cleanHtml = DOMPurify.sanitize(htmlContent, {
                            ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'a', 'ul', 'ol', 'li',
                                           'blockquote', 'code', 'pre', 'strong', 'em', 'img', 'table', 'thead',
                                           'tbody', 'tr', 'th', 'td', 'br', 'hr', 'div', 'span', 'sup', 'sub',
                                           'del', 'ins', 'mark', 'abbr', 'dfn', 'kbd', 'samp', 'var'],
                            ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'id', 'width', 'height'],
                            ALLOWED_URI_REGEXP: /^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|figures):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,
                            ALLOW_DATA_ATTR: false,
                            ALLOW_UNKNOWN_PROTOCOLS: false
                        });
                        contentElement.innerHTML = cleanHtml;

                        // Process LaTeX after sanitization
                        renderMathJax();
                    } else {
                        // DOMPurify not loaded yet, retry
                        console.warn('DOMPurify not loaded, retrying...');
                        setTimeout(sanitizeAndRender, 50);
                    }
                };

                sanitizeAndRender();

            } catch (error) {
                console.error('Error loading markdown:', error);

                // Safely display error message
                const contentElement = document.getElementById('post-content');
                contentElement.innerHTML = '';

                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';

                const errorTitle = document.createElement('h2');
                errorTitle.textContent = 'Error Loading Content';

                const errorMsg = document.createElement('p');
                errorMsg.textContent = error.message;

                errorDiv.appendChild(errorTitle);
                errorDiv.appendChild(errorMsg);
                contentElement.appendChild(errorDiv);
            }
        }

        // Start the initialization
        initializeMarkdownViewer();

        // Also try when DOM is ready as backup
        document.addEventListener('DOMContentLoaded', loadMarkdown);
    }

    // Start initialization when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeMarkdownViewer);
    } else {
        initializeMarkdownViewer();
    }
    </script>
</body>
</html>