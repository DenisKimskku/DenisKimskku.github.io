<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Loading - Minseok (Denis) Kim</title>
    <link rel="stylesheet" href="../styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- MathJax for LaTeX rendering -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                packages: {'[+]': ['noerrors']}
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'annotation', 'annotation-xml']
            },
            loader: {load: ['[tex]/noerrors']},
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    console.log('MathJax is ready');
                    // Trigger a custom event when MathJax is fully ready
                    window.dispatchEvent(new Event('mathjax-ready'));
                }
            }
        };
        
        // Global flag to track MathJax readiness
        window.mathJaxReady = false;
        window.addEventListener('mathjax-ready', () => {
            window.mathJaxReady = true;
        });
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Marked for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"
            integrity="sha512-4IeqgEW/gb0bGI9JVy0K9Q3j8pCmPD5CPRuD9qPTt1Oj9vY5C/7mF4LYEfKTYZFhDmVqPmzYJODHJYd4Z6Rtw=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- DOMPurify for XSS protection -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"
            integrity="sha512-UcpyPKvTVVDFLHF4u4dUW6ey7rLABcBLwsv2TmvMX0A6W3L/mCWy3DGhVqBF8fZDnKqrb9cW/DcWrJ8XLlmwDQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Alternative: KaTeX for faster LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- Prism for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet"
          integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ=="
          crossorigin="anonymous" referrerpolicy="no-referrer">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"
            integrity="sha512-9khQRAUBYEJDCDVP2yw3LRUQvjJ0Pjx0EShmaQjcHa6AXiOv6qHQu9lCATR6c9CTf8wb6wm1wpLxRbTQqxl9iA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"
            integrity="sha512-SkmBfuA2hqjzEVpmnMt/LINrjop3GKWqsuLSSB3e7iBmYK7JuWw4ldmmxwD9mdm2IRTTi0OxSAfEGvgEi0i2Kw=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <div class="site-branding">
                <h1 class="site-title">Minseok (Denis) Kim</h1>
            </div>
            <nav class="main-nav">
                <a href="../#main" class="nav-link">Main</a>
                <a href="../papers/" class="nav-link">Papers</a>
                <a href="../code/" class="nav-link">Code</a>
                <a href="../writing/" class="nav-link">Writing</a>
                <div class="theme-toggle" onclick="toggleTheme()">
                    <div class="theme-icon"></div>
                </div>
            </nav>
        </div>
    </header>

    <main class="content">
        <article class="post-content">
            <div class="container">
                <header class="post-header" id="post-header">
                    <!-- Header content will be populated by JS -->
                </header>

                <div class="post-body" id="post-content">
                    <!-- Markdown content will be rendered here -->
                    <p>Loading...</p>
                </div>

                <footer class="post-footer">
                    <a href="../" class="back-link">‚Üê Back to Writing</a>
                </footer>
            </div>
        </article>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="mailto:for8821@g.skku.edu">Email</a>
                    <a href="https://scholar.google.com/citations?user=81uf6x0AAAAJ&hl=en">Scholar</a>
                    <a href="https://github.com/DenisKimskku">GitHub</a>
                </div>
                <p class="footer-text">¬© 2025 Minseok (Denis) Kim. Building safe AI for everyone.</p>
            </div>
        </div>
    </footer>

    <script src="../script.js"></script>
    <script>
        // Configure marked options for LaTeX compatibility
        marked.setOptions({
            highlight: function(code, lang) {
                if (Prism.languages[lang]) {
                    return Prism.highlight(code, Prism.languages[lang], lang);
                } else {
                    return code;
                }
            },
            langPrefix: 'language-',
            pedantic: false,
            gfm: true,
            breaks: false,
            sanitize: false,
            smartypants: false,
            xhtml: false
        });

        // Custom extensions for marked to preserve LaTeX
        marked.use({
            extensions: [{
                name: 'latex-inline',
                level: 'inline',
                start(src) { return src.indexOf('$'); },
                tokenizer(src, tokens) {
                    const match = src.match(/^\$([^$\n]+?)\$/);
                    if (match) {
                        return {
                            type: 'latex-inline',
                            raw: match[0],
                            text: match[1].trim()
                        };
                    }
                },
                renderer(token) {
                    return `$${token.text}$`;
                }
            }, {
                name: 'latex-display',
                level: 'block',
                start(src) { return src.indexOf('$$'); },
                tokenizer(src, tokens) {
                    const match = src.match(/^\$\$([^$]+?)\$\$/);
                    if (match) {
                        return {
                            type: 'latex-display',
                            raw: match[0],
                            text: match[1].trim()
                        };
                    }
                },
                renderer(token) {
                    return `$$${token.text}$$`;
                }
            }]
        });

        // Function to parse frontmatter
        function parseFrontmatter(content) {
            const frontmatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/;
            const match = content.match(frontmatterRegex);
            
            if (match) {
                const frontmatter = {};
                const frontmatterText = match[1];
                const bodyContent = match[2];
                
                // Parse YAML-like frontmatter
                frontmatterText.split('\n').forEach(line => {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex > 0) {
                        const key = line.substring(0, colonIndex).trim();
                        const value = line.substring(colonIndex + 1).trim().replace(/^["']|["']$/g, '');
                        frontmatter[key] = value;
                    }
                });
                
                return { frontmatter, content: bodyContent };
            }
            
            return { frontmatter: {}, content };
        }

        // Function to render LaTeX with multiple fallbacks
        function renderMathJax() {
            console.log('üî¢ Attempting to render LaTeX...');
            
            const contentElement = document.getElementById('post-content');
            
            // Method 1: Try KaTeX first (faster)
            const tryKaTeX = () => {
                if (window.renderMathInElement && window.katex) {
                    console.log('üìê Using KaTeX for LaTeX rendering...');
                    try {
                        renderMathInElement(contentElement, {
                            delimiters: [
                                {left: '$$', right: '$$', display: true},
                                {left: '$', right: '$', display: false},
                                {left: '\\[', right: '\\]', display: true},
                                {left: '\\(', right: '\\)', display: false}
                            ],
                            throwOnError: false,
                            errorColor: '#cc0000',
                            strict: false
                        });
                        console.log('‚úÖ KaTeX rendering complete');
                        return true;
                    } catch (err) {
                        console.warn('‚ö†Ô∏è KaTeX error, trying MathJax:', err);
                        return false;
                    }
                }
                return false;
            };
            
            // Method 2: Fallback to MathJax
            const tryMathJax = () => {
                if (window.MathJax && MathJax.typesetPromise) {
                    console.log('üßÆ Using MathJax for LaTeX rendering...');
                    MathJax.typesetPromise([contentElement])
                        .then(() => {
                            console.log('‚úÖ MathJax rendering complete');
                        })
                        .catch((err) => {
                            console.error('‚ùå MathJax error:', err);
                        });
                    return true;
                }
                return false;
            };
            
            // Try KaTeX first, then MathJax
            const renderLaTeX = () => {
                if (!tryKaTeX()) {
                    if (!tryMathJax()) {
                        console.log('‚è≥ LaTeX libraries not ready, retrying...');
                        setTimeout(renderLaTeX, 100);
                    }
                }
            };
            
            // Start rendering
            setTimeout(renderLaTeX, 100);
        }

        // Utility function to safely escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Function to load and render markdown
        async function loadMarkdown() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const markdownPath = urlParams.get('md') || urlParams.get('file');

                if (!markdownPath) {
                    throw new Error('No markdown file specified. Use ?md=path/to/file.md');
                }

                const response = await fetch(markdownPath);
                if (!response.ok) {
                    throw new Error(`Failed to load ${markdownPath}: ${response.statusText}`);
                }

                const rawContent = await response.text();
                const { frontmatter, content } = parseFrontmatter(rawContent);

                // Update page title safely
                const title = frontmatter.title || 'Article';
                document.getElementById('page-title').textContent = `${title} - Minseok (Denis) Kim`;

                // Create header content safely using DOM manipulation
                const postHeader = document.getElementById('post-header');
                postHeader.innerHTML = ''; // Clear existing content

                const postMeta = document.createElement('div');
                postMeta.className = 'post-meta';

                const postDate = document.createElement('span');
                postDate.className = 'post-date';
                postDate.textContent = frontmatter.date || '';
                postMeta.appendChild(postDate);

                const postType = document.createElement('span');
                postType.className = 'post-type';
                postType.textContent = frontmatter.type || 'Article';
                postMeta.appendChild(postType);

                const h1 = document.createElement('h1');
                h1.textContent = title;

                postHeader.appendChild(postMeta);
                postHeader.appendChild(h1);

                if (frontmatter.description) {
                    const description = document.createElement('p');
                    description.className = 'post-description';
                    description.textContent = frontmatter.description;
                    postHeader.appendChild(description);
                }

                // Remove the first H1 from content if it matches the title (to avoid duplicate)
                let contentToRender = content;
                const firstH1Match = content.match(/^#\s+(.+)$/m);
                if (firstH1Match && firstH1Match[1].trim() === title.trim()) {
                    contentToRender = content.replace(/^#\s+.+$/m, '').trim();
                }

                // Render markdown with sanitization
                let htmlContent = marked.parse(contentToRender);

                // Fix relative figure paths - assume figures are in figures/article-name/
                const articleName = markdownPath.replace('.md', '').split('/').pop();
                const figuresPath = `figures/${articleName}/`;

                // Replace relative image paths with correct figure paths
                htmlContent = htmlContent.replace(
                    /<img([^>]*?)src="([^"]*?\.(?:png|jpg|jpeg|gif|svg))"([^>]*?)>/gi,
                    (match, prefix, src, suffix) => {
                        // If src doesn't start with http/https and doesn't start with figures/
                        if (!src.startsWith('http') && !src.startsWith('figures/')) {
                            return `<img${prefix}src="${figuresPath}${src}"${suffix}>`;
                        }
                        return match;
                    }
                );

                // Sanitize HTML with DOMPurify before inserting
                const contentElement = document.getElementById('post-content');

                // Wait for DOMPurify to load if not available yet
                const sanitizeAndRender = () => {
                    if (window.DOMPurify) {
                        // Allow MathJax delimiters and common markdown elements
                        const cleanHtml = DOMPurify.sanitize(htmlContent, {
                            ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'a', 'ul', 'ol', 'li',
                                           'blockquote', 'code', 'pre', 'strong', 'em', 'img', 'table', 'thead',
                                           'tbody', 'tr', 'th', 'td', 'br', 'hr', 'div', 'span', 'sup', 'sub',
                                           'del', 'ins', 'mark', 'abbr', 'dfn', 'kbd', 'samp', 'var'],
                            ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'id', 'width', 'height'],
                            ALLOWED_URI_REGEXP: /^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|figures):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,
                            ALLOW_DATA_ATTR: false,
                            ALLOW_UNKNOWN_PROTOCOLS: false
                        });
                        contentElement.innerHTML = cleanHtml;

                        // Process LaTeX after sanitization
                        renderMathJax();
                    } else {
                        // DOMPurify not loaded yet, retry
                        console.warn('DOMPurify not loaded, retrying...');
                        setTimeout(sanitizeAndRender, 50);
                    }
                };

                sanitizeAndRender();

            } catch (error) {
                console.error('Error loading markdown:', error);

                // Safely display error message
                const contentElement = document.getElementById('post-content');
                contentElement.innerHTML = '';

                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';

                const errorTitle = document.createElement('h2');
                errorTitle.textContent = 'Error Loading Content';

                const errorMsg = document.createElement('p');
                errorMsg.textContent = error.message;

                errorDiv.appendChild(errorTitle);
                errorDiv.appendChild(errorMsg);
                contentElement.appendChild(errorDiv);
            }
        }

        // Load markdown when page loads
        document.addEventListener('DOMContentLoaded', loadMarkdown);
    </script>
</body>
</html>